<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#fff1f2">
    <meta name="description" content="æŸ å°èŠ±å·è¯†å­— - å„¿ç«¥è¶£å‘³æ±‰å­—æµ‹è¯•">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="æŸ å°èŠ±å·è¯†å­—">
    <title>æŸ å°èŠ±å·è¯†å­—</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¼</text></svg>">

    <!-- Tailwind CSS (Direct CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@500;700;900&family=Quicksand:wght@500;700&display=swap');
        
        .cursor-custom {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" style="fill:white; stroke:black; stroke-width:1.5px; filter:drop-shadow(2px 2px 2px rgba(0,0,0,0.2));"><path d="M5.5 10.5v-6a2.5 2.5 0 0 1 5 0v5.5a.5.5 0 0 0 .5.5h.5a.5.5 0 0 0 .5-.5v-4a2.5 2.5 0 0 1 5 0v4.5a.5.5 0 0 0 .5.5h.5a.5.5 0 0 0 .5-.5v-2a2.5 2.5 0 0 1 5 0v8a8 8 0 0 1-8 8h-4a7 7 0 0 1-7-7v-6.5a2.5 2.5 0 0 1 5 0z" transform="translate(-2, 0) scale(0.9)"/></svg>') 10 0, auto;
        }

        .cursor-pointer-custom, button, input, a {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" style="fill:%23ffeb3b; stroke:black; stroke-width:1.5px; filter:drop-shadow(2px 2px 2px rgba(0,0,0,0.2));"><path d="M5.5 10.5v-6a2.5 2.5 0 0 1 5 0v5.5a.5.5 0 0 0 .5.5h.5a.5.5 0 0 0 .5-.5v-4a2.5 2.5 0 0 1 5 0v4.5a.5.5 0 0 0 .5.5h.5a.5.5 0 0 0 .5-.5v-2a2.5 2.5 0 0 1 5 0v8a8 8 0 0 1-8 8h-4a7 7 0 0 1-7-7v-6.5a2.5 2.5 0 0 1 5 0z" transform="translate(-2, 0) scale(0.9)"/></svg>') 10 0, pointer !important;
        }
        
        body {
            font-family: 'Quicksand', 'Noto Sans SC', system-ui, sans-serif;
            background-color: #fff1f2;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        .bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .bar-grow {
            animation: growUp 1s ease-out forwards;
            transform-origin: bottom;
            transform: scaleY(0);
        }
        @keyframes growUp { to { transform: scaleY(1); } }
    </style>
</head>
<body class="min-h-screen text-slate-800 bg-gradient-to-br from-pink-50 via-white to-sky-50 cursor-custom">

    <!-- 1. WELCOME SCREEN -->
    <div id="screen-welcome" class="min-h-screen flex flex-col items-center justify-center p-6 text-center space-y-4">
        <div class="space-y-2 mb-4">
            <div class="text-7xl animate-bounce">ğŸ¼</div>
            <h1 class="text-5xl font-black text-sky-500 tracking-wider drop-shadow-sm">æŸ å°èŠ±å·è¯†å­—</h1>
        </div>

        <!-- Stats Card -->
        <div class="w-full max-w-xs bg-white/70 rounded-3xl p-4 backdrop-blur-sm border border-pink-100 shadow-sm">
            <div class="flex justify-between items-baseline mb-3">
                <h3 class="text-gray-500 font-bold text-xs flex items-center gap-1">
                    <span>ğŸ“Š</span> å­¦ä¹ æˆé•¿è®°å½•
                </h3>
                <div class="text-xs text-gray-400">
                    æ€»è¯†å­—: <span id="stat-total-count" class="text-2xl font-black text-sky-500 mx-1">0</span> å­—
                </div>
            </div>
            <!-- Bar Chart -->
            <div id="stats-chart" class="flex items-end justify-between h-20 gap-1 pt-2 px-1">
                <div class="w-full h-full flex items-center justify-center text-gray-300 text-xs">åŠ è½½æ•°æ®...</div>
            </div>
        </div>
        
        <!-- Game Controls -->
        <div class="flex flex-col gap-3 w-full max-w-xs z-10 mt-2">
            
            <!-- Question Count Selector -->
            <div class="bg-white/80 rounded-2xl p-2 flex justify-between items-center w-full shadow-sm">
                <span class="text-xs font-bold text-gray-400 ml-2 uppercase tracking-wide">æœ¬è½®é¢˜æ•°</span>
                <div class="flex gap-1 bg-gray-100 rounded-xl p-1">
                    <button onclick="setQCount(10)" id="btn-count-10" class="flex-1 py-1 px-3 rounded-lg text-sm font-bold transition-all bg-white text-sky-500 shadow-sm">10</button>
                    <button onclick="setQCount(20)" id="btn-count-20" class="flex-1 py-1 px-3 rounded-lg text-sm font-bold text-gray-400 hover:text-gray-600 transition-all">20</button>
                    <button onclick="setQCount(30)" id="btn-count-30" class="flex-1 py-1 px-3 rounded-lg text-sm font-bold text-gray-400 hover:text-gray-600 transition-all">30</button>
                </div>
            </div>

            <!-- Start Button -->
            <button onclick="startGame()" class="bg-sky-400 hover:bg-sky-500 text-white border-b-4 border-sky-600 font-bold rounded-2xl px-6 py-4 text-2xl active:scale-95 transition-all w-full shadow-lg flex flex-col items-center group">
                <span class="group-hover:scale-105 transition-transform">ğŸš€ å¼€å§‹æŒ‘æˆ˜</span>
            </button>

            <!-- Mistake Book Button -->
            <button onclick="openMistakeModal()" class="relative bg-orange-400 hover:bg-orange-500 text-white border-b-4 border-orange-600 font-bold rounded-2xl px-6 py-3 text-lg active:scale-95 transition-all w-full shadow-lg">
                ğŸ“– æˆ‘çš„é”™é¢˜æœ¬
                <span id="mistake-badge-main" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center border-2 border-white hidden">0</span>
            </button>
            
            <div class="text-[10px] text-gray-300 w-full text-right pr-2">
                 <button onclick="clearAllData()" class="hover:text-red-300 transition-colors">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰æ•°æ®</button>
            </div>
        </div>

        <!-- Simple Settings Section -->
        <div class="w-full max-w-xs mt-4">
            <button onclick="toggleSettingsPanel()" class="w-full text-center text-xs text-gray-400 font-bold hover:text-sky-500 transition-colors flex items-center justify-center gap-2 mb-2">
                <span>âš™ï¸ è®¾ç½® (API Key)</span>
                <span id="settings-arrow">â–¼</span>
            </button>

            <div id="settings-panel" class="hidden space-y-3 bg-white/60 p-4 rounded-3xl border border-pink-100 backdrop-blur-sm shadow-sm transition-all duration-300">
                <div class="space-y-1">
                    <label class="text-[10px] text-gray-400 font-bold ml-2 uppercase">Google API Key</label>
                    <input type="password" id="api-key-input" placeholder="è¯·ç²˜è´´ AIza å¼€å¤´çš„ Key" 
                        class="w-full px-4 py-2 rounded-xl border-2 border-pink-200 focus:border-pink-400 focus:outline-none text-center bg-white/90 font-mono text-sm" />
                </div>
                <p class="text-[10px] text-gray-400 leading-tight text-center">
                    è¯·ç¡®ä¿æ‚¨çš„ç½‘ç»œç¯å¢ƒå¯ä»¥è®¿é—® Google (VPN)
                </p>
            </div>
        </div>
    </div>

    <!-- 2. LOADING SCREEN -->
    <div id="screen-loading" class="hidden min-h-screen flex flex-col items-center justify-center text-center p-8">
        <div class="w-20 h-20 border-8 border-sky-200 border-t-sky-500 rounded-full animate-spin mb-8"></div>
        <h2 class="text-3xl font-bold text-sky-600 mb-2">æ­£åœ¨å‡ºé¢˜ä¸­...</h2>
        <p class="text-gray-400">AI è€å¸ˆæ­£åœ¨å‡†å¤‡ <span id="loading-count">10</span> é“é¢˜ç›®...</p>
    </div>

    <!-- 3. QUIZ SCREEN -->
    <div id="screen-quiz" class="hidden min-h-screen flex flex-col items-center p-4 md:p-8 max-w-2xl mx-auto w-full">
        <!-- Header -->
        <div class="w-full flex justify-between items-center mb-6">
            <button onclick="goHome()" class="bg-white hover:bg-gray-5 text-gray-600 border border-gray-200 font-bold rounded-xl px-4 py-2 text-sm shadow-sm">
                ğŸ  é€€å‡º
            </button>
            <div class="flex flex-col items-end">
                 <div class="text-xs text-gray-400 font-bold uppercase tracking-widest">è¿›åº¦</div>
                 <div class="text-2xl font-black text-sky-500 font-sans"><span id="current-q-num">1</span> / <span id="total-q-num">10</span></div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="w-full h-4 bg-gray-200 rounded-full mb-8 overflow-hidden">
            <div id="progress-bar" class="h-full bg-sky-400 transition-all duration-500 ease-out rounded-full" style="width: 10%"></div>
        </div>

        <!-- Question Card -->
        <div class="bg-white rounded-3xl p-10 w-full shadow-xl border-4 border-amber-200 flex flex-col items-center justify-center mb-8 relative overflow-hidden card-shadow">
            <div class="absolute -top-10 -left-10 w-24 h-24 bg-yellow-100 rounded-full opacity-50"></div>
            <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-pink-100 rounded-full opacity-50"></div>
            
            <h2 id="question-instruction" class="text-gray-400 text-lg font-bold mb-2 z-10 tracking-wide">é¢˜ç›®</h2>
            <div id="question-text" class="font-black z-10 text-slate-700 text-8xl transition-all">?</div>
        </div>

        <!-- Options -->
        <div id="options-grid" class="grid grid-cols-2 gap-4 w-full"></div>
    </div>

    <!-- 4. FEEDBACK MODAL -->
    <div id="modal-feedback" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm cursor-custom">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl bounce-in border-4 border-white ring-4 ring-yellow-200 relative">
            
            <!-- Icon -->
            <div class="flex justify-center -mt-16 mb-4">
                <div id="feedback-icon-bg" class="rounded-full p-4 border-4 border-white shadow-lg bg-gray-200">
                    <span id="feedback-icon" class="text-4xl">ğŸ¤”</span>
                </div>
            </div>

            <div class="text-center mb-6">
                <h2 id="feedback-title" class="text-3xl font-bold mb-2">...</h2>
                <div class="flex items-center justify-center gap-4 text-slate-700 bg-slate-50 rounded-xl p-4 mx-auto w-fit border border-slate-100">
                    <span id="fb-char" class="text-5xl font-black"></span>
                    <span id="fb-pinyin" class="text-3xl font-bold text-slate-500"></span>
                </div>
            </div>

            <div class="space-y-3 mb-8">
                <h3 class="text-gray-400 font-bold text-xs uppercase tracking-wider text-center">è¯è¯­å­¦ä¹ </h3>
                <div id="examples-list" class="space-y-2"></div>
            </div>

            <button onclick="nextQuestion()" class="bg-sky-400 hover:bg-sky-500 text-white border-b-4 border-sky-600 font-bold rounded-2xl px-6 py-3 text-xl w-full active:scale-95 transition-all shadow-md">
                ç»§ç»­ä¸‹ä¸€é¢˜ â”
            </button>
        </div>
    </div>

    <!-- 5. MISTAKE BOOK MODAL -->
    <div id="modal-mistakes" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm cursor-custom">
        <div class="bg-white rounded-3xl w-full max-w-md h-[80vh] flex flex-col p-6 shadow-2xl border-4 border-orange-200 relative">
            
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-black text-orange-500">ğŸ“– æˆ‘çš„é”™é¢˜æœ¬</h2>
                <button onclick="closeMistakeModal()" class="text-gray-400 hover:text-gray-600 text-xl font-bold">âœ•</button>
            </div>

            <div id="mistake-empty-state" class="hidden flex-1 flex flex-col items-center justify-center text-center text-gray-400">
                <span class="text-6xl mb-4">ğŸŒŸ</span>
                <p class="font-bold">å¤ªæ£’äº†ï¼<br>æš‚æ—¶æ²¡æœ‰é”™é¢˜å“¦ï¼</p>
            </div>

            <div id="mistake-list" class="flex-1 overflow-y-auto space-y-2 pr-2 mb-4"></div>

            <button id="btn-review-mistakes" onclick="startReviewGame()" class="bg-orange-400 hover:bg-orange-500 text-white border-b-4 border-orange-600 font-bold rounded-2xl px-6 py-3 text-lg w-full active:scale-95 transition-all hidden shadow-md">
                âœï¸ å¼€å§‹å¤ä¹ è¿™äº›å­—
            </button>
        </div>
    </div>

    <!-- 6. FINISHED SCREEN -->
    <div id="screen-finished" class="hidden flex flex-col items-center justify-center min-h-screen p-8 text-center space-y-8 bg-white/50">
        <div id="final-emoji" class="text-8xl animate-bounce">ğŸ†</div>
        <div>
            <h2 id="final-title" class="text-4xl font-black mb-2 text-slate-800">å®Œæˆå•¦!</h2>
            <p class="text-gray-500 text-xl font-bold">ä¸€å…± <span id="final-total">10</span> é¢˜ï¼Œç­”å¯¹ <span id="final-score">0</span> é¢˜</p>
        </div>

        <div class="text-7xl font-black text-slate-800 drop-shadow-md font-sans">
            <span id="final-points">0</span><span class="text-3xl text-gray-400 ml-2 font-bold">åˆ†</span>
        </div>

        <div class="flex gap-4 w-full max-w-xs pt-4">
            <button onclick="goHome()" class="flex-1 bg-white hover:bg-gray-50 text-gray-700 border-b-4 border-gray-200 font-bold rounded-2xl px-4 py-3 active:scale-95">
                è¿”å›é¦–é¡µ
            </button>
            <button onclick="replayGame()" class="flex-1 bg-green-400 hover:bg-green-500 text-white border-b-4 border-green-600 font-bold rounded-2xl px-4 py-3 active:scale-95">
                å†ç©ä¸€æ¬¡
            </button>
        </div>
    </div>

    <!-- LOGIC SCRIPT -->
    <script type="module">
        // --- CONSTANTS ---
        const MASTERY_KEY = 'HANZI_MASTERY_LIST';
        const MISTAKE_KEY = 'HANZI_MISTAKES_LIST';
        const TOTAL_MASTERY_KEY = 'HANZI_TOTAL_MASTERY_SET';
        const DAILY_STATS_KEY = 'HANZI_DAILY_STATS_LOG';
        const API_KEY_KEY = 'GEMINI_API_KEY';
        const MAX_MASTERY_SIZE = 100;

        // --- GLOBAL STATE ---
        // Defined explicitly to ensure availability
        window.appState = {
            items: [], 
            currentIndex: 0,
            score: 0,
            targetCount: 10,
            apiKey: '',
            isReview: false
        };

        // --- GLOBAL BUTTON HANDLERS (DEFINED FIRST) ---
        // Defining these first ensures that even if localstorage data is corrupt,
        // the buttons (especially Settings and Reset) still work.

        window.setQCount = (n) => {
            window.appState.targetCount = n;
            [10, 20, 30].forEach(val => {
                const btn = document.getElementById(`btn-count-${val}`);
                if(btn) {
                    btn.className = (val === n) 
                        ? "flex-1 py-1 px-3 rounded-lg text-sm font-bold transition-all bg-white text-sky-500 shadow-sm"
                        : "flex-1 py-1 px-3 rounded-lg text-sm font-bold text-gray-400 hover:text-gray-600 transition-all";
                }
            });
            playSound('click');
        };

        window.toggleSettingsPanel = () => {
            const el = document.getElementById('settings-panel');
            const arrow = document.getElementById('settings-arrow');
            if(el && arrow) {
                el.classList.toggle('hidden');
                arrow.innerText = el.classList.contains('hidden') ? 'â–¼' : 'â–²';
            }
        };

        window.goHome = () => { 
            playSound('click'); 
            showScreen('welcome'); 
            updateStatsUI(); 
        };

        window.clearAllData = () => {
            if(confirm('è­¦å‘Šï¼šç¡®å®šè¦é‡ç½®æ‰€æœ‰è¯†å­—è®°å½•ã€é”™é¢˜æœ¬å’Œç»Ÿè®¡æ•°æ®å—ï¼Ÿ')) {
                try {
                    localStorage.removeItem(MASTERY_KEY);
                    localStorage.removeItem(MISTAKE_KEY);
                    localStorage.removeItem(TOTAL_MASTERY_KEY);
                    localStorage.removeItem(DAILY_STATS_KEY);
                } catch(e) { console.error(e); }
                alert("æ•°æ®å·²é‡ç½®");
                updateStatsUI();
                // If a modal is open, try to close it or refresh content
                if(!document.getElementById('modal-mistakes').classList.contains('hidden')) {
                    window.openMistakeModal();
                }
            }
        };

        window.closeMistakeModal = () => { 
            playSound('click'); 
            document.getElementById('modal-mistakes').classList.add('hidden'); 
        };

        window.openMistakeModal = () => {
            playSound('click');
            const list = getSafeJSON(MISTAKE_KEY, []);
            const container = document.getElementById('mistake-list');
            const emptyState = document.getElementById('mistake-empty-state');
            const btnReview = document.getElementById('btn-review-mistakes');
            
            if(!container || !emptyState || !btnReview) return;

            container.innerHTML = '';

            if (list.length === 0) {
                emptyState.classList.remove('hidden');
                btnReview.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                btnReview.classList.remove('hidden');
                list.forEach(item => {
                    const row = document.createElement('div');
                    row.className = "flex items-center justify-between bg-orange-50 p-3 rounded-xl border border-orange-100";
                    row.innerHTML = `<div class="flex items-center gap-3">
                            <span class="text-3xl font-black text-orange-600 bg-white w-12 h-12 flex items-center justify-center rounded-lg shadow-sm border border-orange-200 font-sans">${item.character}</span>
                            <span class="text-lg font-bold text-gray-600 font-sans">${item.pinyin}</span>
                        </div>`;
                    container.appendChild(row);
                });
            }
            document.getElementById('modal-mistakes').classList.remove('hidden');
        };

        window.startReviewGame = () => {
            const list = getSafeJSON(MISTAKE_KEY, []);
            if (list.length === 0) return;
            window.closeMistakeModal();
            playSound('start');
            let items = [...list].sort(() => Math.random() - 0.5);
            const limit = window.appState.targetCount || 10;
            if (items.length > limit) items = items.slice(0, limit);
            items.forEach(item => {
                item.mode = Math.random() < 0.5 ? 'HANZI_TO_PINYIN' : 'PINYIN_TO_HANZI';
            });
            window.appState.items = items;
            window.appState.currentIndex = 0;
            window.appState.score = 0;
            window.appState.isReview = true; 
            renderQuestion();
            showScreen('quiz');
        };

        window.replayGame = () => {
            const mistakes = getSafeJSON(MISTAKE_KEY, []);
            if (window.appState.isReview && mistakes.length > 0) window.startReviewGame();
            else if (window.appState.isReview) { alert("é”™é¢˜å…¨éƒ¨å¤ä¹ å®Œå•¦ï¼"); window.goHome(); }
            else window.startGame();
        };

        window.nextQuestion = () => {
            document.getElementById('modal-feedback').classList.add('hidden');
            playSound('click');
            if (window.appState.currentIndex < window.appState.items.length - 1) {
                window.appState.currentIndex++;
                renderQuestion();
            } else {
                finishGame();
            }
        };

        window.startGame = async () => {
            initAudio(); 
            playSound('start');
            window.appState.isReview = false;
            
            const inputKey = document.getElementById('api-key-input');
            const key = inputKey.value.trim();
            
            if (!key) {
                const el = document.getElementById('settings-panel');
                if(el && el.classList.contains('hidden')) window.toggleSettingsPanel();
                if(el) {
                    el.classList.add('shake');
                    setTimeout(() => el.classList.remove('shake'), 500);
                }
                inputKey.focus();
                return;
            }
            window.appState.apiKey = key;
            try { localStorage.setItem(API_KEY_KEY, key); } catch(e){}

            showScreen('loading');
            const countEl = document.getElementById('loading-count');
            if(countEl) countEl.innerText = window.appState.targetCount;

            try {
                const mastered = getSafeJSON(MASTERY_KEY, []); 
                const data = await fetchQuizData(window.appState.apiKey, mastered, window.appState.targetCount);
                data.items.forEach(item => {
                    item.mode = Math.random() < 0.5 ? 'HANZI_TO_PINYIN' : 'PINYIN_TO_HANZI';
                });
                window.appState.items = data.items;
                window.appState.currentIndex = 0;
                window.appState.score = 0;
                renderQuestion();
                showScreen('quiz');
            } catch (e) {
                console.error(e);
                alert("å‡ºé¢˜å¤±è´¥ï¼è¯·ç¡®ä¿å¼€å¯äº† VPN (Global Mode) ä¸” Key æ­£ç¡®ã€‚\n\né”™è¯¯ä¿¡æ¯: " + e.message);
                showScreen('welcome');
            }
        };

        // --- HELPER FUNCTIONS ---

        // Robust LocalStorage Reader
        function getSafeJSON(key, defaultVal) {
            try {
                const val = localStorage.getItem(key);
                if (!val) return defaultVal;
                return JSON.parse(val);
            } catch (e) {
                console.warn(`Failed to parse ${key}`, e);
                // Return default on error to prevent app crash
                return defaultVal;
            }
        }

        function getTodayStr() {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showScreen(name) {
            const screens = ['screen-welcome', 'screen-loading', 'screen-quiz', 'screen-finished'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            const target = document.getElementById(name);
            if(target) target.classList.remove('hidden');
        }

        function saveMasteryAndStats(char) {
            try {
                const totalList = getSafeJSON(TOTAL_MASTERY_KEY, []);
                const totalSet = new Set(totalList);
                const dailyStats = getSafeJSON(DAILY_STATS_KEY, {});
                const today = getTodayStr();

                if (!totalSet.has(char)) {
                    totalSet.add(char);
                    localStorage.setItem(TOTAL_MASTERY_KEY, JSON.stringify([...totalSet]));
                    dailyStats[today] = (dailyStats[today] || 0) + 1;
                    localStorage.setItem(DAILY_STATS_KEY, JSON.stringify(dailyStats));
                }

                let recentList = getSafeJSON(MASTERY_KEY, []);
                recentList = recentList.filter(c => c !== char);
                recentList.push(char);
                if (recentList.length > MAX_MASTERY_SIZE) recentList = recentList.slice(recentList.length - MAX_MASTERY_SIZE);
                localStorage.setItem(MASTERY_KEY, JSON.stringify(recentList));
                updateStatsUI();
            } catch(e) { console.error("Save error", e); }
        }

        function addToMistakes(item) {
            try {
                let list = getSafeJSON(MISTAKE_KEY, []);
                if (!list.find(i => i.character === item.character)) {
                    const cleanItem = {
                        character: item.character,
                        pinyin: item.pinyin,
                        wrongPinyins: item.wrongPinyins,
                        wrongChars: item.wrongChars,
                        examples: item.examples
                    };
                    list.push(cleanItem);
                    localStorage.setItem(MISTAKE_KEY, JSON.stringify(list));
                    updateStatsUI();
                }
            } catch(e) { console.error("Mistake save error", e); }
        }

        function removeFromMistakes(char) {
            try {
                let list = getSafeJSON(MISTAKE_KEY, []);
                const initialLength = list.length;
                list = list.filter(i => i.character !== char);
                if (list.length !== initialLength) {
                    localStorage.setItem(MISTAKE_KEY, JSON.stringify(list));
                    updateStatsUI();
                    return true;
                }
            } catch(e) { console.error("Mistake remove error", e); }
            return false;
        }

        function updateStatsUI() {
            try {
                const mistakeList = getSafeJSON(MISTAKE_KEY, []);
                const elBadge = document.getElementById('mistake-badge-main');
                if (elBadge) {
                    if (mistakeList.length > 0) {
                        elBadge.innerText = mistakeList.length;
                        elBadge.classList.remove('hidden');
                    } else {
                        elBadge.classList.add('hidden');
                    }
                }
                const totalList = getSafeJSON(TOTAL_MASTERY_KEY, []);
                const elTotal = document.getElementById('stat-total-count');
                if(elTotal) elTotal.innerText = totalList.length;
                renderChart();
            } catch(e) { console.error("UI update error", e); }
        }

        function renderChart() {
            const chartContainer = document.getElementById('stats-chart');
            if(!chartContainer) return;
            chartContainer.innerHTML = '';
            
            const dailyStats = getSafeJSON(DAILY_STATS_KEY, {});
            const days = 7;
            let maxVal = 0;
            const dataPoints = [];

            for (let i = days - 1; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const dateStr = `${d.getFullYear()}-${month}-${day}`;
                const count = dailyStats[dateStr] || 0;
                if(count > maxVal) maxVal = count;
                dataPoints.push({ date: `${month}/${day}`, count, fullDate: dateStr });
            }
            if (maxVal === 0) maxVal = 5;

            dataPoints.forEach((pt, idx) => {
                const heightPercent = Math.max(15, (pt.count / maxVal) * 100);
                const isToday = pt.fullDate === getTodayStr();
                const col = document.createElement('div');
                col.className = "flex-1 flex flex-col items-center justify-end h-full group relative";
                col.innerHTML = `
                    <div class="absolute -top-8 bg-slate-700 text-white text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">${pt.count} å­—</div>
                    <div class="w-3 md:w-4 rounded-t-md ${isToday ? 'bg-sky-400' : 'bg-pink-200'} bar-grow relative" style="height: ${heightPercent}%; animation-delay: ${idx * 0.1}s">
                         ${pt.count > 0 ? `<div class="absolute -top-4 w-full text-center text-[9px] text-gray-400 font-bold">${pt.count}</div>` : ''}
                    </div>
                    <div class="text-[9px] text-gray-400 mt-1 scale-90">${pt.date}</div>
                `;
                chartContainer.appendChild(col);
            });
        }

        async function fetchQuizData(apiKey, excludedChars, qCount = 10) {
            const excludedStr = excludedChars.slice(-50).join(', ');
            const promptText = `
            Create ${qCount} quiz items for Chinese primary school students (Grades 1-2).
            IMPORTANT: Do NOT use these characters: [${excludedStr}]. Pick different simple ones.
            Format: JSON.
            Structure:
            {
              "items": [
                {
                  "character": "æ±‰å­—",
                  "pinyin": "pinyin",
                  "wrongPinyins": ["w1", "w2", "w3"],
                  "wrongChars": ["é”™1", "é”™2", "é”™3"],
                  "examples": [
                    {"word": "è¯1", "pinyin": "p1"},
                    {"word": "è¯2", "pinyin": "p2"},
                    {"word": "è¯3", "pinyin": "p3"}
                  ]
                }
              ]
            }`;

            // --- STRICT GOOGLE SDK LOGIC ---
            let GoogleGenAI;
            try {
                const module = await import("https://esm.run/@google/genai");
                GoogleGenAI = module.GoogleGenAI;
            } catch (e) {
                throw new Error("æ— æ³•åŠ è½½ Google AI SDKã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ (VPN)ã€‚");
            }

            const ai = new GoogleGenAI({ apiKey });
            // Using updated official model
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: promptText,
                config: { responseMimeType: "application/json" }
            });
            
            if(!response || !response.text) throw new Error("API è¿”å›ä¸ºç©º");
            return JSON.parse(response.text);
        }

        function renderQuestion() {
            const item = window.appState.items[window.appState.currentIndex];
            const isHanziMode = (item.mode === 'HANZI_TO_PINYIN');
            
            document.getElementById('current-q-num').innerText = window.appState.currentIndex + 1;
            document.getElementById('total-q-num').innerText = window.appState.items.length;
            document.getElementById('progress-bar').style.width = `${((window.appState.currentIndex) / window.appState.items.length) * 100}%`;
            document.getElementById('question-instruction').innerText = isHanziMode ? "è¯·é€‰æ‹©æ­£ç¡®çš„æ‹¼éŸ³" : "è¯·é€‰æ‹©å¯¹åº”çš„æ±‰å­—";
            
            const qText = document.getElementById('question-text');
            qText.innerText = isHanziMode ? item.character : item.pinyin;
            qText.className = isHanziMode 
                ? "font-black z-10 text-slate-700 text-8xl transition-all" 
                : "font-bold z-10 text-slate-700 text-6xl transition-all font-sans";

            const correct = isHanziMode ? item.pinyin : item.character;
            const wrongs = isHanziMode ? item.wrongPinyins : item.wrongChars;
            const options = [...wrongs, correct].sort(() => Math.random() - 0.5);

            const grid = document.getElementById('options-grid');
            grid.innerHTML = ''; 
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "bg-white hover:bg-sky-50 hover:text-sky-600 hover:border-sky-300 text-slate-600 border-2 border-slate-200 font-bold rounded-2xl h-20 text-3xl shadow-sm active:scale-95 transition-all font-sans";
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(opt, correct, item);
                grid.appendChild(btn);
            });
        }

        function handleAnswer(selected, correct, item) {
            const isCorrect = selected === correct;
            let removed = false;
            if (isCorrect) {
                window.appState.score++;
                playSound('correct');
                saveMasteryAndStats(item.character);
                removed = removeFromMistakes(item.character);
            } else {
                playSound('wrong');
                addToMistakes(item);
            }
            showFeedback(isCorrect, removed);
        }

        function showFeedback(isCorrect, removed) {
            const item = window.appState.items[window.appState.currentIndex];
            const title = document.getElementById('feedback-title');
            const iconBg = document.getElementById('feedback-icon-bg');
            const icon = document.getElementById('feedback-icon');

            if (isCorrect) {
                title.innerText = "ç­”å¯¹å•¦ï¼";
                title.className = "text-3xl font-bold mb-2 text-green-500";
                iconBg.className = "rounded-full p-4 border-4 border-white shadow-lg bg-green-400";
                icon.innerText = "ğŸŒŸ";
                if (removed) title.innerHTML += "<br><span class='text-sm text-orange-400'>å·²ä»é”™é¢˜æœ¬ç§»å‡º!</span>";
            } else {
                title.innerText = "è®°å…¥é”™é¢˜æœ¬ï¼";
                title.className = "text-3xl font-bold mb-2 text-orange-500";
                iconBg.className = "rounded-full p-4 border-4 border-white shadow-lg bg-orange-400";
                icon.innerText = "ğŸ“";
            }
            document.getElementById('fb-char').innerText = item.character;
            document.getElementById('fb-pinyin').innerText = item.pinyin;
            const list = document.getElementById('examples-list');
            list.innerHTML = '';
            item.examples.forEach(ex => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-center bg-amber-50 p-3 rounded-xl border border-amber-100";
                row.innerHTML = `<span class="text-lg font-bold text-amber-800 font-sans">${ex.word}</span><span class="text-md text-amber-600 font-mono font-bold">${ex.pinyin}</span>`;
                list.appendChild(row);
            });
            document.getElementById('modal-feedback').classList.remove('hidden');
        }

        function finishGame() {
            setTimeout(() => playSound('victory'), 300);
            showScreen('finished');
            document.getElementById('final-total').innerText = window.appState.items.length;
            document.getElementById('final-score').innerText = window.appState.score;
            document.getElementById('final-points').innerText = window.appState.score * 10;
            const percent = (window.appState.score / window.appState.items.length) * 100;
            let emoji = 'ğŸ˜'; let title = 'å®Œæˆ!';
            if(percent === 100) { emoji='ğŸ†'; title='æ»¡åˆ†! å¤ªæ£’äº†!'; }
            else if(percent >= 80) { emoji='ğŸ‰'; title='éå¸¸ä¼˜ç§€!'; }
            else if(percent >= 60) { emoji='ğŸ‘'; title='ç»§ç»­åŠ æ²¹!'; }
            document.getElementById('final-emoji').innerText = emoji;
            document.getElementById('final-title').innerText = title;
        }

        // --- AUDIO SYSTEM ---
        let audioCtx = null;
        window.initAudio = () => {
            if (!audioCtx) {
                const AC = window.AudioContext || window.webkitAudioContext;
                if (AC) audioCtx = new AC();
            }
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        };

        window.playSound = (type) => {
            try {
                if (!audioCtx) window.initAudio();
                if (!audioCtx) return;
                const t = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                if (type === 'click') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(600, t); osc.frequency.exponentialRampToValueAtTime(1000, t+0.08);
                    gain.gain.setValueAtTime(0.05, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.08);
                    osc.connect(gain); gain.connect(audioCtx.destination); osc.start(t); osc.stop(t+0.08);
                } else if (type === 'correct') {
                    [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => {
                        const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = 'triangle';
                        o.frequency.setValueAtTime(f, t);
                        g.gain.setValueAtTime(0, t+i*0.08); g.gain.linearRampToValueAtTime(0.05, t+i*0.08+0.02); g.gain.exponentialRampToValueAtTime(0.001, t+i*0.08+0.4);
                        o.connect(g); g.connect(audioCtx.destination); o.start(t+i*0.08); o.stop(t+i*0.08+0.5);
                    });
                } else if (type === 'wrong') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); osc.frequency.linearRampToValueAtTime(100, t+0.3);
                    gain.gain.setValueAtTime(0.05, t); gain.gain.linearRampToValueAtTime(0, t+0.3);
                    osc.connect(gain); gain.connect(audioCtx.destination); osc.start(t); osc.stop(t+0.3);
                } else if (type === 'victory') {
                    [523, 659, 783, 1046, 1318, 1567].forEach((f, i) => {
                        const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = 'square';
                        o.frequency.setValueAtTime(f, t+i*0.08);
                        g.gain.setValueAtTime(0, t+i*0.08); g.gain.linearRampToValueAtTime(0.04, t+i*0.08+0.05); g.gain.exponentialRampToValueAtTime(0.001, t+i*0.08+0.3);
                        o.connect(g); g.connect(audioCtx.destination); o.start(t+i*0.08); o.stop(t+i*0.08+0.4);
                    });
                } else if (type === 'start') {
                    osc.frequency.setValueAtTime(200, t); osc.frequency.exponentialRampToValueAtTime(800, t+0.3);
                    gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.08, t+0.1); gain.gain.linearRampToValueAtTime(0, t+0.3);
                    osc.connect(gain); gain.connect(audioCtx.destination); osc.start(t); osc.stop(t+0.3);
                }
            } catch(e) { console.error("Audio error", e); }
        };

        // --- INITIALIZATION (EXECUTES LAST) ---
        (function init() {
            try {
                // Restore API Key
                const savedKey = localStorage.getItem(API_KEY_KEY);
                if (savedKey) {
                    window.appState.apiKey = savedKey;
                    const inputKey = document.getElementById('api-key-input');
                    if(inputKey) inputKey.value = savedKey;
                }
                
                // Initialize Stats UI
                updateStatsUI();
                
                // Initialize default selection
                window.setQCount(10);
            } catch (e) {
                console.error("Initialization error:", e);
                // Even if init fails, buttons are defined above and will work.
            }
        })();
    </script>
</body>
</html>