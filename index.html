<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#fff1f2">
    <meta name="description" content="ç»µç»µè¯†å­— - å„¿ç«¥è¶£å‘³æ±‰å­—æµ‹è¯•">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="ç»µç»µè¯†å­—">
    <title>ç»µç»µè¯†å­—</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¼</text></svg>">

    <!-- Tailwind CSS (Direct CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <style>
        /* å¼•å…¥ Quicksand (ç”¨äºæ‹¼éŸ³/è‹±æ–‡ï¼Œæ¸…æ™°åœ†æ¶¦) å’Œ Noto Sans SC (ç”¨äºæ±‰å­—ï¼Œç¬”ç”»æ¸…æ™°) */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@500;700;900&family=Quicksand:wght@500;700&display=swap');
        
        /* 
           1. è‡ªå®šä¹‰é¼ æ ‡æ ·å¼ (60px å¡é€šç™½æ‰‹å¥—)
           SVG ç»˜åˆ¶äº†ä¸€ä¸ªå¯çˆ±çš„ç™½è‰²å¡«å……ã€é»‘è‰²æè¾¹çš„æ‰‹æŒ‡
        */
        .cursor-custom {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" style="fill:white; stroke:black; stroke-width:1.5px; filter:drop-shadow(2px 2px 2px rgba(0,0,0,0.2));"><path d="M5.5 10.5v-6a2.5 2.5 0 0 1 5 0v5.5a.5.5 0 0 0 .5.5h.5a.5.5 0 0 0 .5-.5v-4a2.5 2.5 0 0 1 5 0v4.5a.5.5 0 0 0 .5.5h.5a.5.5 0 0 0 .5-.5v-2a2.5 2.5 0 0 1 5 0v8a8 8 0 0 1-8 8h-4a7 7 0 0 1-7-7v-6.5a2.5 2.5 0 0 1 5 0z" transform="translate(-2, 0) scale(0.9)"/></svg>') 10 0, auto;
        }

        /* æŒ‰é’®æ‚¬åœæ—¶æ ·å¼ */
        .cursor-pointer-custom, button, input, a {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" style="fill:%23ffeb3b; stroke:black; stroke-width:1.5px; filter:drop-shadow(2px 2px 2px rgba(0,0,0,0.2));"><path d="M5.5 10.5v-6a2.5 2.5 0 0 1 5 0v5.5a.5.5 0 0 0 .5.5h.5a.5.5 0 0 0 .5-.5v-4a2.5 2.5 0 0 1 5 0v4.5a.5.5 0 0 0 .5.5h.5a.5.5 0 0 0 .5-.5v-2a2.5 2.5 0 0 1 5 0v8a8 8 0 0 1-8 8h-4a7 7 0 0 1-7-7v-6.5a2.5 2.5 0 0 1 5 0z" transform="translate(-2, 0) scale(0.9)"/></svg>') 10 0, pointer !important;
        }
        
        body {
            /* ä¼˜å…ˆä½¿ç”¨ Quicksand æ˜¾ç¤ºæ‹¼éŸ³å­—æ¯ï¼Œç„¶åä½¿ç”¨ Noto Sans SC æ˜¾ç¤ºæ±‰å­— */
            font-family: 'Quicksand', 'Noto Sans SC', system-ui, sans-serif;
            background-color: #fff1f2;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        .bounce-in {
            animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>

    <!-- Import Map for Google GenAI SDK -->
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.run/@google/genai"
      }
    }
    </script>
</head>
<body class="min-h-screen text-slate-800 bg-gradient-to-br from-pink-50 via-white to-sky-50 cursor-custom">

    <!-- 1. WELCOME SCREEN -->
    <div id="screen-welcome" class="min-h-screen flex flex-col items-center justify-center p-6 text-center space-y-6">
        <div class="space-y-2 mb-8">
            <div class="text-7xl animate-bounce">ğŸ¼</div>
            <h1 class="text-6xl font-black text-sky-500 tracking-wider drop-shadow-sm">ç»µç»µè¯†å­—</h1>
        </div>
        
        <!-- Game Mode Buttons (Unified) -->
        <div class="flex flex-col gap-4 w-full max-w-xs z-10">
            <!-- Unified Start Button -->
            <button onclick="startGame()" class="bg-sky-400 hover:bg-sky-500 text-white border-b-4 border-sky-600 font-bold rounded-2xl px-6 py-5 text-2xl active:scale-95 transition-all w-full shadow-lg flex flex-col items-center">
                <span>ğŸš€ å¼€å§‹æŒ‘æˆ˜</span>
                <span class="text-sm opacity-80 font-normal mt-1 text-sky-100">çœ‹å­—é€‰éŸ³ / çœ‹éŸ³é€‰å­— (æ··åˆ)</span>
            </button>

            <!-- Mistake Book Button -->
            <button onclick="openMistakeModal()" class="relative bg-orange-400 hover:bg-orange-500 text-white border-b-4 border-orange-600 font-bold rounded-2xl px-6 py-4 text-xl active:scale-95 transition-all w-full shadow-lg mt-2">
                ğŸ“– æˆ‘çš„é”™é¢˜æœ¬
                <span id="mistake-badge-main" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center border-2 border-white hidden">0</span>
            </button>

            <div class="text-xs text-gray-400 pt-2 flex justify-between items-center px-2">
                <span>å·²å­¦ä¼š <span id="mastery-count" class="font-bold text-green-500">0</span> ä¸ªæ±‰å­—</span>
                <button onclick="clearMastery()" class="text-red-300 underline hover:text-red-400">é‡ç½®</button>
            </div>
        </div>

        <!-- Settings Section (Collapsed by default) -->
        <div class="w-full max-w-xs mt-8">
            <button onclick="toggleSettingsPanel()" class="w-full text-center text-xs text-gray-400 font-bold hover:text-sky-500 transition-colors flex items-center justify-center gap-2 mb-2">
                <span>âš™ï¸ è®¾ç½® (API Key & æœåŠ¡å™¨)</span>
                <span id="settings-arrow">â–¼</span>
            </button>

            <div id="settings-panel" class="hidden space-y-3 bg-white/60 p-4 rounded-3xl border border-pink-100 backdrop-blur-sm shadow-sm transition-all duration-300">
                <!-- API Key Input -->
                <div class="space-y-1">
                    <label class="text-[10px] text-gray-400 font-bold ml-2 uppercase">Google API Key</label>
                    <input type="password" id="api-key-input" placeholder="ç²˜è´´ä½ çš„ API Key" 
                        class="w-full px-4 py-2 rounded-xl border-2 border-pink-200 focus:border-pink-400 focus:outline-none text-center bg-white/90 font-mono text-sm" />
                </div>

                <!-- Base URL Input -->
                <div class="space-y-1">
                    <label class="text-[10px] text-gray-400 font-bold ml-2 uppercase">æœåŠ¡å™¨åœ°å€ (Base URL)</label>
                    <input type="text" id="base-url-input" placeholder="é»˜è®¤ (ç©º)" 
                        class="w-full px-4 py-2 rounded-xl border-2 border-slate-200 focus:border-sky-400 focus:outline-none text-center bg-white/90 font-mono text-sm" />
                    <p class="text-[10px] text-gray-400 leading-tight text-center">å›½å†…ç›´è¿è¯·å¡«ä»£ç†åœ°å€<br>(ä¾‹å¦‚: https://api.laozhang.ai/v1)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. LOADING SCREEN -->
    <div id="screen-loading" class="hidden min-h-screen flex flex-col items-center justify-center text-center p-8">
        <div class="w-20 h-20 border-8 border-sky-200 border-t-sky-500 rounded-full animate-spin mb-8"></div>
        <h2 class="text-3xl font-bold text-sky-600 mb-2">æ­£åœ¨å‡ºé¢˜ä¸­...</h2>
        <p class="text-gray-400">AI è€å¸ˆæ­£åœ¨å‡†å¤‡è¯•å·...</p>
    </div>

    <!-- 3. QUIZ SCREEN -->
    <div id="screen-quiz" class="hidden min-h-screen flex flex-col items-center p-4 md:p-8 max-w-2xl mx-auto w-full">
        <!-- Header -->
        <div class="w-full flex justify-between items-center mb-6">
            <button onclick="goHome()" class="bg-white hover:bg-gray-50 text-gray-600 border border-gray-200 font-bold rounded-xl px-4 py-2 text-sm shadow-sm">
                ğŸ  é€€å‡º
            </button>
            <div class="flex flex-col items-end">
                 <div class="text-xs text-gray-400 font-bold uppercase tracking-widest">è¿›åº¦</div>
                 <div class="text-2xl font-black text-sky-500 font-sans"><span id="current-q-num">1</span> / <span id="total-q-num">10</span></div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="w-full h-4 bg-gray-200 rounded-full mb-8 overflow-hidden">
            <div id="progress-bar" class="h-full bg-sky-400 transition-all duration-500 ease-out rounded-full" style="width: 10%"></div>
        </div>

        <!-- Question Card -->
        <div class="bg-white rounded-3xl p-10 w-full shadow-xl border-4 border-amber-200 flex flex-col items-center justify-center mb-8 relative overflow-hidden card-shadow">
            <div class="absolute -top-10 -left-10 w-24 h-24 bg-yellow-100 rounded-full opacity-50"></div>
            <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-pink-100 rounded-full opacity-50"></div>
            
            <h2 id="question-instruction" class="text-gray-400 text-lg font-bold mb-2 z-10 tracking-wide">é¢˜ç›®</h2>
            <div id="question-text" class="font-black z-10 text-slate-700 text-8xl transition-all">
                ?
            </div>
        </div>

        <!-- Options -->
        <div id="options-grid" class="grid grid-cols-2 gap-4 w-full">
            <!-- Buttons injected by JS -->
        </div>
    </div>

    <!-- 4. FEEDBACK MODAL -->
    <div id="modal-feedback" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm cursor-custom">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl bounce-in border-4 border-white ring-4 ring-yellow-200 relative">
            
            <!-- Icon -->
            <div class="flex justify-center -mt-16 mb-4">
                <div id="feedback-icon-bg" class="rounded-full p-4 border-4 border-white shadow-lg bg-gray-200">
                    <span id="feedback-icon" class="text-4xl">ğŸ¤”</span>
                </div>
            </div>

            <div class="text-center mb-6">
                <h2 id="feedback-title" class="text-3xl font-bold mb-2">...</h2>
                <div class="flex items-center justify-center gap-4 text-slate-700 bg-slate-50 rounded-xl p-4 mx-auto w-fit border border-slate-100">
                    <span id="fb-char" class="text-5xl font-black"></span>
                    <span id="fb-pinyin" class="text-3xl font-bold text-slate-500"></span>
                </div>
            </div>

            <div class="space-y-3 mb-8">
                <h3 class="text-gray-400 font-bold text-xs uppercase tracking-wider text-center">è¯è¯­å­¦ä¹ </h3>
                <div id="examples-list" class="space-y-2">
                    <!-- Examples injected by JS -->
                </div>
            </div>

            <button onclick="nextQuestion()" class="bg-sky-400 hover:bg-sky-500 text-white border-b-4 border-sky-600 font-bold rounded-2xl px-6 py-3 text-xl w-full active:scale-95 transition-all shadow-md">
                ç»§ç»­ä¸‹ä¸€é¢˜ â”
            </button>
        </div>
    </div>

    <!-- 5. MISTAKE BOOK MODAL -->
    <div id="modal-mistakes" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm cursor-custom">
        <div class="bg-white rounded-3xl w-full max-w-md h-[80vh] flex flex-col p-6 shadow-2xl border-4 border-orange-200 relative">
            
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-black text-orange-500">ğŸ“– æˆ‘çš„é”™é¢˜æœ¬</h2>
                <button onclick="closeMistakeModal()" class="text-gray-400 hover:text-gray-600 text-xl font-bold">âœ•</button>
            </div>

            <div id="mistake-empty-state" class="hidden flex-1 flex flex-col items-center justify-center text-center text-gray-400">
                <span class="text-6xl mb-4">ğŸŒŸ</span>
                <p class="font-bold">å¤ªæ£’äº†ï¼<br>æš‚æ—¶æ²¡æœ‰é”™é¢˜å“¦ï¼</p>
            </div>

            <!-- List -->
            <div id="mistake-list" class="flex-1 overflow-y-auto space-y-2 pr-2 mb-4">
                <!-- Items injected here -->
            </div>

            <button id="btn-review-mistakes" onclick="startReviewGame()" class="bg-orange-400 hover:bg-orange-500 text-white border-b-4 border-orange-600 font-bold rounded-2xl px-6 py-3 text-lg w-full active:scale-95 transition-all hidden shadow-md">
                âœï¸ å¼€å§‹å¤ä¹ è¿™äº›å­—
            </button>
        </div>
    </div>

    <!-- 6. FINISHED SCREEN -->
    <div id="screen-finished" class="hidden flex flex-col items-center justify-center min-h-screen p-8 text-center space-y-8 bg-white/50">
        <div id="final-emoji" class="text-8xl animate-bounce">ğŸ†</div>
        <div>
            <h2 id="final-title" class="text-4xl font-black mb-2 text-slate-800">å®Œæˆå•¦!</h2>
            <p class="text-gray-500 text-xl font-bold">ä¸€å…± <span id="final-total">10</span> é¢˜ï¼Œç­”å¯¹ <span id="final-score">0</span> é¢˜</p>
        </div>

        <div class="text-7xl font-black text-slate-800 drop-shadow-md font-sans">
            <span id="final-points">0</span><span class="text-3xl text-gray-400 ml-2 font-bold">åˆ†</span>
        </div>

        <div class="flex gap-4 w-full max-w-xs pt-4">
            <button onclick="goHome()" class="flex-1 bg-white hover:bg-gray-50 text-gray-700 border-b-4 border-gray-200 font-bold rounded-2xl px-4 py-3 active:scale-95">
                è¿”å›é¦–é¡µ
            </button>
            <button onclick="replayGame()" class="flex-1 bg-green-400 hover:bg-green-500 text-white border-b-4 border-green-600 font-bold rounded-2xl px-4 py-3 active:scale-95">
                å†ç©ä¸€æ¬¡
            </button>
        </div>
    </div>

    <!-- LOGIC SCRIPT -->
    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // --- STATE ---
        let appState = {
            items: [], // Each item now has a 'mode' property: 'HANZI_TO_PINYIN' or 'PINYIN_TO_HANZI'
            currentIndex: 0,
            score: 0,
            apiKey: localStorage.getItem('GEMINI_API_KEY') || '',
            baseUrl: localStorage.getItem('GEMINI_BASE_URL') || ''
        };

        // --- STORAGE KEYS ---
        const MASTERY_KEY = 'HANZI_MASTERY_LIST';
        const MISTAKE_KEY = 'HANZI_MISTAKES_LIST';
        const MAX_MASTERY_SIZE = 100;

        // --- MASTERY LOGIC ---
        function getMasteredChars() {
            try { return JSON.parse(localStorage.getItem(MASTERY_KEY) || '[]'); } catch (e) { return []; }
        }

        function saveMastery(char) {
            let list = getMasteredChars();
            list = list.filter(c => c !== char);
            list.push(char);
            if (list.length > MAX_MASTERY_SIZE) list = list.slice(list.length - MAX_MASTERY_SIZE);
            localStorage.setItem(MASTERY_KEY, JSON.stringify(list));
            updateStats();
        }

        window.clearMastery = () => {
            if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²å­¦ä¼šçš„æ±‰å­—è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem(MASTERY_KEY);
                updateStats();
            }
        }

        // --- MISTAKE BANK LOGIC ---
        function getMistakes() {
            try { return JSON.parse(localStorage.getItem(MISTAKE_KEY) || '[]'); } catch (e) { return []; }
        }

        function addToMistakes(item) {
            let list = getMistakes();
            // Avoid duplicates
            if (!list.find(i => i.character === item.character)) {
                // Ensure we save a clean item without the temporary mode property
                const cleanItem = {
                    character: item.character,
                    pinyin: item.pinyin,
                    wrongPinyins: item.wrongPinyins,
                    wrongChars: item.wrongChars,
                    examples: item.examples
                };
                list.push(cleanItem);
                localStorage.setItem(MISTAKE_KEY, JSON.stringify(list));
                updateStats();
            }
        }

        function removeFromMistakes(char) {
            let list = getMistakes();
            const initialLength = list.length;
            list = list.filter(i => i.character !== char);
            if (list.length !== initialLength) {
                localStorage.setItem(MISTAKE_KEY, JSON.stringify(list));
                updateStats();
                return true; // Indicates it was removed
            }
            return false;
        }

        function updateStats() {
            // Update Mastery Count
            const masterList = getMasteredChars();
            const elMastery = document.getElementById('mastery-count');
            if(elMastery) elMastery.innerText = masterList.length;

            // Update Mistake Badge
            const mistakeList = getMistakes();
            const elBadge = document.getElementById('mistake-badge-main');
            if (elBadge) {
                if (mistakeList.length > 0) {
                    elBadge.innerText = mistakeList.length;
                    elBadge.classList.remove('hidden');
                } else {
                    elBadge.classList.add('hidden');
                }
            }
        }

        // --- DOM ELEMENTS ---
        const screens = {
            welcome: document.getElementById('screen-welcome'),
            loading: document.getElementById('screen-loading'),
            quiz: document.getElementById('screen-quiz'),
            finished: document.getElementById('screen-finished')
        };
        const modals = {
            feedback: document.getElementById('modal-feedback'),
            mistakes: document.getElementById('modal-mistakes')
        };
        const inputKey = document.getElementById('api-key-input');
        const inputBaseUrl = document.getElementById('base-url-input');

        // Init
        if (appState.apiKey) inputKey.value = appState.apiKey;
        if (appState.baseUrl) inputBaseUrl.value = appState.baseUrl;
        updateStats();

        // --- NAVIGATION ---
        function showScreen(name) {
            Object.values(screens).forEach(el => el.classList.add('hidden'));
            if(screens[name]) screens[name].classList.remove('hidden');
        }

        window.goHome = () => {
            playSound('click');
            showScreen('welcome');
            updateStats();
        };

        window.toggleSettingsPanel = () => {
            const el = document.getElementById('settings-panel');
            const arrow = document.getElementById('settings-arrow');
            el.classList.toggle('hidden');
            if (el.classList.contains('hidden')) {
                arrow.innerText = 'â–¼';
            } else {
                arrow.innerText = 'â–²';
            }
        };

        // --- MISTAKE UI HANDLERS ---
        window.openMistakeModal = () => {
            playSound('click');
            const list = getMistakes();
            const container = document.getElementById('mistake-list');
            const emptyState = document.getElementById('mistake-empty-state');
            const btnReview = document.getElementById('btn-review-mistakes');
            
            container.innerHTML = '';

            if (list.length === 0) {
                emptyState.classList.remove('hidden');
                btnReview.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                btnReview.classList.remove('hidden');
                
                list.forEach(item => {
                    const row = document.createElement('div');
                    row.className = "flex items-center justify-between bg-orange-50 p-3 rounded-xl border border-orange-100";
                    row.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="text-3xl font-black text-orange-600 bg-white w-12 h-12 flex items-center justify-center rounded-lg shadow-sm border border-orange-200 font-sans">${item.character}</span>
                            <span class="text-lg font-bold text-gray-600 font-sans">${item.pinyin}</span>
                        </div>
                    `;
                    container.appendChild(row);
                });
            }

            modals.mistakes.classList.remove('hidden');
        }

        window.closeMistakeModal = () => {
            playSound('click');
            modals.mistakes.classList.add('hidden');
        }

        window.startReviewGame = () => {
            const list = getMistakes();
            if (list.length === 0) return;
            
            window.closeMistakeModal();
            playSound('start');
            
            // Setup Review Mode
            // Shuffle mistakes
            let items = [...list].sort(() => Math.random() - 0.5);
            // Limit to 10 for a session
            if (items.length > 10) items = items.slice(0, 10);
            
            // Assign random mode to each review item
            items.forEach(item => {
                item.mode = Math.random() < 0.5 ? 'HANZI_TO_PINYIN' : 'PINYIN_TO_HANZI';
            });
            
            appState.items = items;
            appState.currentIndex = 0;
            appState.score = 0;
            appState.isReview = true; // Flag to know if we are in review
            
            renderQuestion();
            showScreen('quiz');
        }

        // --- GAME START LOGIC (API) ---
        window.startGame = async () => {
            initAudio(); 
            playSound('start');
            appState.isReview = false;

            const key = inputKey.value.trim();
            const url = inputBaseUrl.value.trim();
            
            if (!key) {
                const el = document.getElementById('settings-panel');
                if(el.classList.contains('hidden')) {
                    window.toggleSettingsPanel();
                }
                el.classList.add('shake');
                setTimeout(() => el.classList.remove('shake'), 500);
                inputKey.focus();
                return;
            }
            
            appState.apiKey = key;
            appState.baseUrl = url;
            localStorage.setItem('GEMINI_API_KEY', key);
            localStorage.setItem('GEMINI_BASE_URL', url);

            showScreen('loading');

            try {
                const mastered = getMasteredChars();
                const data = await fetchQuizData(appState.apiKey, appState.baseUrl, mastered);
                
                // Randomly assign mode to each item
                data.items.forEach(item => {
                    item.mode = Math.random() < 0.5 ? 'HANZI_TO_PINYIN' : 'PINYIN_TO_HANZI';
                });

                appState.items = data.items;
                appState.currentIndex = 0;
                appState.score = 0;
                
                renderQuestion();
                showScreen('quiz');
            } catch (e) {
                console.error(e);
                let msg = "å‡ºé¢˜å¤±è´¥äº†ï¼š\n" + e.message;
                if(e.message.includes('403') || e.message.includes('Failed to fetch')) {
                   msg += "\n\næç¤ºï¼šè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¡®è®¤ä»£ç†åœ°å€æ˜¯å¦æ­£ç¡®ã€‚";
                }
                alert(msg);
                showScreen('welcome');
            }
        };

        window.replayGame = () => {
            if (appState.isReview) {
                const list = getMistakes();
                if (list.length > 0) {
                    window.startReviewGame();
                } else {
                    alert("é”™é¢˜å…¨éƒ¨å¤ä¹ å®Œå•¦ï¼çœŸæ£’ï¼");
                    goHome();
                }
            } else {
                window.startGame();
            }
        };

        // --- GEMINI SERVICE ---
        async function fetchQuizData(apiKey, baseUrl, excludedChars) {
            const excludedStr = excludedChars.slice(-50).join(', ');
            const promptText = `
            Create 10 quiz items for Chinese primary school students (Grades 1-2).
            **IMPORTANT**: Exclude these chars: [${excludedStr}]. Choose different simple ones.
            Format: JSON.
            Structure:
            {
              "items": [
                {
                  "character": "æ±‰å­—",
                  "pinyin": "pinyin",
                  "wrongPinyins": ["w1", "w2", "w3"],
                  "wrongChars": ["é”™1", "é”™2", "é”™3"],
                  "examples": [
                    {"word": "è¯1", "pinyin": "p1"},
                    {"word": "è¯2", "pinyin": "p2"},
                    {"word": "è¯3", "pinyin": "p3"}
                  ]
                }
              ]
            }`;

            // --- STRATEGY 1: OpenAI Compatible Proxy (for sk- keys) ---
            if (apiKey.startsWith('sk-')) {
                // Ensure URL ends correctly for OpenAI format
                let url = baseUrl;
                if (!url) throw new Error("ä½¿ç”¨ sk- å¼€å¤´çš„ Key å¿…é¡»å¡«å†™æœåŠ¡å™¨åœ°å€ (Base URL)");
                
                // Normalize URL
                if (url.endsWith('/')) url = url.slice(0, -1);
                
                // Append /chat/completions if not present
                if (!url.endsWith('/chat/completions')) {
                    url = `${url}/chat/completions`;
                }

                // Use simple fetch to bypass Google SDK
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gemini-1.5-flash", // Use 1.5-flash as it is widely supported by proxies
                        messages: [
                            { role: "system", content: "You are a helpful JSON generator." },
                            { role: "user", content: promptText }
                        ],
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const err = await response.text();
                    throw new Error(`Proxy Error (${response.status}): ${err}`);
                }

                const data = await response.json();
                const content = data.choices?.[0]?.message?.content;
                if (!content) throw new Error("No content received from proxy");
                
                // Clean markdown if present
                const jsonStr = content.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(jsonStr);
            }

            // --- STRATEGY 2: Google Official SDK (for AIza keys) ---
            const options = { apiKey };
            if (baseUrl && baseUrl.length > 0) options.baseUrl = baseUrl;

            const ai = new GoogleGenAI(options);
            const response = await ai.models.generateContent({
                model: "gemini-2.5-flash",
                contents: promptText,
                config: { responseMimeType: "application/json" }
            });
            return JSON.parse(response.text);
        }

        // --- RENDER GAME ---
        function renderQuestion() {
            const item = appState.items[appState.currentIndex];
            // Determine mode from item property. Default to HANZI_TO_PINYIN if missing.
            const isHanziMode = (item.mode === 'HANZI_TO_PINYIN');

            // Update Header
            document.getElementById('current-q-num').innerText = appState.currentIndex + 1;
            document.getElementById('total-q-num').innerText = appState.items.length;
            document.getElementById('progress-bar').style.width = `${((appState.currentIndex) / appState.items.length) * 100}%`;

            // Update Card
            document.getElementById('question-instruction').innerText = isHanziMode ? "è¯·é€‰æ‹©æ­£ç¡®çš„æ‹¼éŸ³" : "è¯·é€‰æ‹©å¯¹åº”çš„æ±‰å­—";
            const qText = document.getElementById('question-text');
            qText.innerText = isHanziMode ? item.character : item.pinyin;
            
            // Adjust font size for pinyin vs hanzi
            qText.className = isHanziMode 
                ? "font-black z-10 text-slate-700 text-8xl transition-all" 
                : "font-bold z-10 text-slate-700 text-6xl transition-all font-sans";

            // Options
            const correct = isHanziMode ? item.pinyin : item.character;
            const wrongs = isHanziMode ? item.wrongPinyins : item.wrongChars;
            const options = [...wrongs, correct].sort(() => Math.random() - 0.5);

            const grid = document.getElementById('options-grid');
            grid.innerHTML = ''; 

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "bg-white hover:bg-sky-50 hover:text-sky-600 hover:border-sky-300 text-slate-600 border-2 border-slate-200 font-bold rounded-2xl h-20 text-3xl shadow-sm active:scale-95 transition-all font-sans";
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(opt, correct, item);
                grid.appendChild(btn);
            });
        }

        function handleAnswer(selected, correct, item) {
            const isCorrect = selected === correct;
            let removedFromMistakes = false;

            if (isCorrect) {
                appState.score++;
                playSound('correct');
                saveMastery(item.character);
                // Important: Remove from mistakes if correct!
                removedFromMistakes = removeFromMistakes(item.character);
            } else {
                playSound('wrong');
                // Add to mistakes if wrong!
                addToMistakes(item);
            }

            showFeedback(isCorrect, removedFromMistakes);
        }

        function showFeedback(isCorrect, removedFromMistakes) {
            const item = appState.items[appState.currentIndex];
            const title = document.getElementById('feedback-title');
            const iconBg = document.getElementById('feedback-icon-bg');
            const icon = document.getElementById('feedback-icon');

            if (isCorrect) {
                title.innerText = "ç­”å¯¹å•¦ï¼";
                title.className = "text-3xl font-bold mb-2 text-green-500";
                iconBg.className = "rounded-full p-4 border-4 border-white shadow-lg bg-green-400";
                icon.innerText = "ğŸŒŸ";
                
                if (removedFromMistakes) {
                    title.innerHTML += "<br><span class='text-sm text-orange-400'>å·²ä»é”™é¢˜æœ¬ç§»å‡º!</span>";
                }

            } else {
                title.innerText = "è®°å…¥é”™é¢˜æœ¬ï¼";
                title.className = "text-3xl font-bold mb-2 text-orange-500";
                iconBg.className = "rounded-full p-4 border-4 border-white shadow-lg bg-orange-400";
                icon.innerText = "ğŸ“";
            }

            document.getElementById('fb-char').innerText = item.character;
            document.getElementById('fb-pinyin').innerText = item.pinyin;

            const list = document.getElementById('examples-list');
            list.innerHTML = '';
            item.examples.forEach(ex => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-center bg-amber-50 p-3 rounded-xl border border-amber-100";
                row.innerHTML = `<span class="text-lg font-bold text-amber-800 font-sans">${ex.word}</span><span class="text-md text-amber-600 font-mono font-bold">${ex.pinyin}</span>`;
                list.appendChild(row);
            });

            modals.feedback.classList.remove('hidden');
        }

        window.nextQuestion = () => {
            modals.feedback.classList.add('hidden');
            playSound('click');
            
            if (appState.currentIndex < appState.items.length - 1) {
                appState.currentIndex++;
                renderQuestion();
            } else {
                finishGame();
            }
        };

        function finishGame() {
            setTimeout(() => playSound('victory'), 300);
            showScreen('finished');
            
            document.getElementById('final-total').innerText = appState.items.length;
            document.getElementById('final-score').innerText = appState.score;
            document.getElementById('final-points').innerText = appState.score * 10;

            const percent = (appState.score / appState.items.length) * 100;
            let emoji = 'ğŸ˜'; 
            let title = 'å®Œæˆ!';
            
            if(percent === 100) { emoji='ğŸ†'; title='æ»¡åˆ†! å¤ªæ£’äº†!'; }
            else if(percent >= 80) { emoji='ğŸ‰'; title='éå¸¸ä¼˜ç§€!'; }
            else if(percent >= 60) { emoji='ğŸ‘'; title='ç»§ç»­åŠ æ²¹!'; }

            document.getElementById('final-emoji').innerText = emoji;
            document.getElementById('final-title').innerText = title;
        }

        // --- AUDIO SERVICE (Vanilla) ---
        let audioCtx = null;
        window.initAudio = () => {
            if (!audioCtx) {
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                if (AudioContextClass) audioCtx = new AudioContext();
            }
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        };

        window.playSound = (type) => {
            if (!audioCtx) window.initAudio();
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            
            if (type === 'click') {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, t);
                osc.frequency.exponentialRampToValueAtTime(1000, t + 0.08);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.08);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(t); osc.stop(t + 0.08);
            } else if (type === 'correct') {
                [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(f, t);
                    const st = t + i * 0.08;
                    gain.gain.setValueAtTime(0, st);
                    gain.gain.linearRampToValueAtTime(0.05, st + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.001, st + 0.4);
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.start(st); osc.stop(st + 0.5);
                });
            } else if (type === 'wrong') {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, t);
                osc.frequency.linearRampToValueAtTime(100, t + 0.3);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.3);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(t); osc.stop(t + 0.3);
            } else if (type === 'victory') {
                [523, 659, 783, 1046, 1318, 1567].forEach((f, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'square';
                    const st = t + i * 0.08;
                    osc.frequency.setValueAtTime(f, st);
                    gain.gain.setValueAtTime(0, st);
                    gain.gain.linearRampToValueAtTime(0.04, st + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, st + 0.3);
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.start(st); osc.stop(st + 0.4);
                });
            } else if (type === 'start') {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.frequency.setValueAtTime(200, t);
                osc.frequency.exponentialRampToValueAtTime(800, t + 0.3);
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.08, t + 0.1);
                gain.gain.linearRampToValueAtTime(0, t + 0.3);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(t); osc.stop(t + 0.3);
            }
        };
    </script>
</body>
</html>